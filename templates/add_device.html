{% extends 'base.html' %}

{% block title %}Add New IoT Device{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Add New IoT Device</h5>
                </div>
                <div class="card-body">
                    <form id="addDeviceForm">
                        <!-- Device Information -->
                        <div class="mb-3">
                            <label for="device_id" class="form-label">Device ID *</label>
                            <input type="text" class="form-control" id="device_id" required 
                                   placeholder="e.g., ESP32_001, PICO_001">
                            <small class="form-text text-muted">Unique identifier for your device</small>
                        </div>

                        <div class="mb-3">
                            <label for="device_name" class="form-label">Device Name *</label>
                            <input type="text" class="form-control" id="device_name" required 
                                   placeholder="e.g., Living Room Sensor">
                        </div>

                        <div class="mb-3">
                            <label for="device_type" class="form-label">Device Type *</label>
                            <select class="form-select" id="device_type" required onchange="generateCode()">
                                <option value="">Select Device Type</option>
                                <option value="ESP32">ESP32</option>
                                <option value="ESP8266">ESP8266</option>
                                <option value="PICO WH">Raspberry Pi Pico WH</option>
                                <option value="Arduino">Arduino with WiFi Shield</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="location" class="form-label">Location</label>
                            <input type="text" class="form-control" id="location" 
                                   placeholder="e.g., Living Room, Office, Garden">
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" rows="3" 
                                      placeholder="Brief description of the device and its purpose"></textarea>
                        </div>

                        <!-- WiFi Configuration -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-wifi me-2"></i>WiFi Configuration</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="wifi_ssid" class="form-label">WiFi SSID *</label>
                                    <input type="text" class="form-control" id="wifi_ssid" required 
                                           placeholder="Your WiFi Network Name" onchange="generateCode()">
                                </div>

                                <div class="mb-3">
                                    <label for="wifi_password" class="form-label">WiFi Password *</label>
                                    <input type="password" class="form-control" id="wifi_password" required 
                                           placeholder="WiFi Password" onchange="generateCode()">
                                </div>

                                <div class="mb-3">
                                    <label for="wifi_security" class="form-label">Security Type</label>
                                    <select class="form-select" id="wifi_security" onchange="generateCode()">
                                        <option value="WPA2">WPA2 (Recommended)</option>
                                        <option value="WPA">WPA</option>
                                        <option value="WEP">WEP</option>
                                        <option value="OPEN">Open (No Security)</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="server_endpoint" class="form-label">Server Endpoint</label>
                                    <input type="text" class="form-control" id="server_endpoint" 
                                           value="http://localhost:5001/api/sensor-data" onchange="generateCode()">
                                    <small class="form-text text-muted">API endpoint where device will send data</small>
                                </div>
                            </div>
                        </div>

                        <!-- Sensor Capabilities -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-microchip me-2"></i>Sensor Capabilities</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="has_temperature" onchange="generateCode()">
                                            <label class="form-check-label" for="has_temperature">
                                                <i class="fas fa-thermometer-half text-danger me-1"></i>Temperature
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="has_humidity" onchange="generateCode()">
                                            <label class="form-check-label" for="has_humidity">
                                                <i class="fas fa-tint text-info me-1"></i>Humidity
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="has_pressure" onchange="generateCode()">
                                            <label class="form-check-label" for="has_pressure">
                                                <i class="fas fa-gauge text-warning me-1"></i>Pressure
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="has_light" onchange="generateCode()">
                                            <label class="form-check-label" for="has_light">
                                                <i class="fas fa-sun text-yellow me-1"></i>Light
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="has_motion" onchange="generateCode()">
                                            <label class="form-check-label" for="has_motion">
                                                <i class="fas fa-walking text-success me-1"></i>Motion
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="has_gas" onchange="generateCode()">
                                            <label class="form-check-label" for="has_gas">
                                                <i class="fas fa-smog text-secondary me-1"></i>Gas/Air Quality
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save me-2"></i>Add Device
                            </button>
                            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Generated Code Panel -->
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-code me-2"></i>Generated Code</h5>
                    <div class="btn-group">
                        <button type="button" class="btn btn-outline-light btn-sm" onclick="switchCodeLanguage('arduino')" id="arduinoBtn">
                            Arduino/C++
                        </button>
                        <button type="button" class="btn btn-outline-light btn-sm" onclick="switchCodeLanguage('micropython')" id="micropythonBtn">
                            MicroPython
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="codeContainer" style="height: 600px; overflow-y: auto;">
                        <pre id="generatedCode" class="language-cpp"><code>// Configure your device settings first to generate code
// Select device type, WiFi settings, and sensor capabilities</code></pre>
                    </div>
                    <div class="card-footer">
                        <button class="btn btn-outline-primary btn-sm" onclick="copyCode()" id="copyBtn">
                            <i class="fas fa-copy me-1"></i>Copy Code
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="downloadCode()" id="downloadBtn">
                            <i class="fas fa-download me-1"></i>Download
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Alert for feedback -->
<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="alertToast" class="toast" role="alert">
        <div class="toast-header">
            <i class="fas fa-info-circle me-2 text-primary"></i>
            <strong class="me-auto">Device Manager</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="alertMessage">
        </div>
    </div>
</div>

<script>
let currentCodeLanguage = 'arduino';

// Form submission handler
document.getElementById('addDeviceForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = {
        device_id: document.getElementById('device_id').value,
        device_name: document.getElementById('device_name').value,
        device_type: document.getElementById('device_type').value,
        location: document.getElementById('location').value,
        description: document.getElementById('description').value,
        wifi_ssid: document.getElementById('wifi_ssid').value,
        wifi_password: document.getElementById('wifi_password').value,
        wifi_security: document.getElementById('wifi_security').value,
        server_endpoint: document.getElementById('server_endpoint').value,
        has_temperature: document.getElementById('has_temperature').checked,
        has_humidity: document.getElementById('has_humidity').checked,
        has_pressure: document.getElementById('has_pressure').checked,
        has_light: document.getElementById('has_light').checked,
        has_motion: document.getElementById('has_motion').checked,
        has_gas: document.getElementById('has_gas').checked
    };
    
    try {
        const response = await fetch('/api/devices', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showAlert('Device added successfully!', 'success');
            // Reset form after successful submission
            setTimeout(() => {
                document.getElementById('addDeviceForm').reset();
                generateCode();
            }, 1500);
        } else {
            showAlert(result.error || 'Error adding device', 'error');
        }
    } catch (error) {
        showAlert('Error connecting to server', 'error');
        console.error('Error:', error);
    }
});

// Code generation function
function generateCode() {
    const deviceType = document.getElementById('device_type').value;
    const deviceId = document.getElementById('device_id').value || 'YOUR_DEVICE_ID';
    const wifiSSID = document.getElementById('wifi_ssid').value || 'YOUR_WIFI_SSID';
    const wifiPassword = document.getElementById('wifi_password').value || 'YOUR_WIFI_PASSWORD';
    const serverEndpoint = document.getElementById('server_endpoint').value || 'http://localhost:5001/api/sensor-data';
    
    const sensors = {
        temperature: document.getElementById('has_temperature').checked,
        humidity: document.getElementById('has_humidity').checked,
        pressure: document.getElementById('has_pressure').checked,
        light: document.getElementById('has_light').checked,
        motion: document.getElementById('has_motion').checked,
        gas: document.getElementById('has_gas').checked
    };
    
    let code = '';
    
    if (currentCodeLanguage === 'arduino') {
        code = generateArduinoCode(deviceType, deviceId, wifiSSID, wifiPassword, serverEndpoint, sensors);
    } else {
        code = generateMicroPythonCode(deviceType, deviceId, wifiSSID, wifiPassword, serverEndpoint, sensors);
    }
    
    document.getElementById('generatedCode').textContent = code;
}

// Arduino/C++ Code Generation
function generateArduinoCode(deviceType, deviceId, wifiSSID, wifiPassword, serverEndpoint, sensors) {
    let includes = '#include <WiFi.h>\n#include <HTTPClient.h>\n#include <ArduinoJson.h>\n';
    let sensorIncludes = '';
    let sensorDeclarations = '';
    let sensorSetup = '';
    let sensorReadings = '';
    let jsonData = '';
    
    // Add sensor-specific includes and code
    if (sensors.temperature || sensors.humidity) {
        sensorIncludes += '#include <DHT.h>\n';
        sensorDeclarations += '\n// DHT Sensor\n#define DHT_PIN 2\n#define DHT_TYPE DHT22\nDHT dht(DHT_PIN, DHT_TYPE);\n';
        sensorSetup += '  dht.begin();\n';
        if (sensors.temperature) {
            sensorReadings += '  float temperature = dht.readTemperature();\n';
            jsonData += '  doc["temperature"] = temperature;\n';
        }
        if (sensors.humidity) {
            sensorReadings += '  float humidity = dht.readHumidity();\n';
            jsonData += '  doc["humidity"] = humidity;\n';
        }
    }
    
    if (sensors.pressure) {
        sensorIncludes += '#include <Adafruit_BMP280.h>\n';
        sensorDeclarations += '\n// BMP280 Pressure Sensor\nAdafruit_BMP280 bmp;\n';
        sensorSetup += '  bmp.begin();\n';
        sensorReadings += '  float pressure = bmp.readPressure() / 100.0F;\n';
        jsonData += '  doc["pressure"] = pressure;\n';
    }
    
    if (sensors.light) {
        sensorDeclarations += '\n// Light Sensor (LDR)\n#define LDR_PIN A0\n';
        sensorReadings += '  int lightLevel = analogRead(LDR_PIN);\n';
        jsonData += '  doc["light"] = lightLevel;\n';
    }
    
    if (sensors.motion) {
        sensorDeclarations += '\n// Motion Sensor (PIR)\n#define PIR_PIN 3\n';
        sensorSetup += '  pinMode(PIR_PIN, INPUT);\n';
        sensorReadings += '  bool motion = digitalRead(PIR_PIN);\n';
        jsonData += '  doc["motion"] = motion;\n';
    }
    
    if (sensors.gas) {
        sensorDeclarations += '\n// Gas Sensor (MQ-2)\n#define GAS_PIN A1\n';
        sensorReadings += '  int gasLevel = analogRead(GAS_PIN);\n';
        jsonData += '  doc["gas"] = gasLevel;\n';
    }
    
    return `${includes}${sensorIncludes}
// WiFi Configuration
const char* ssid = "${wifiSSID}";
const char* password = "${wifiPassword}";
const char* serverURL = "${serverEndpoint}";
const char* deviceID = "${deviceId}";
${sensorDeclarations}
void setup() {
  Serial.begin(115200);
  
  // Initialize sensors
${sensorSetup}
  
  // Connect to WiFi
  WiFi.begin(ssid, password);
  Serial.print("Connecting to WiFi");
  
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  
  Serial.println();
  Serial.println("WiFi connected!");
  Serial.print("IP address: ");
  Serial.println(WiFi.localIP());
}

void loop() {
  if (WiFi.status() == WL_CONNECTED) {
    // Read sensor data
${sensorReadings}
    
    // Create JSON payload
    StaticJsonDocument<200> doc;
    doc["device_id"] = deviceID;
    doc["timestamp"] = millis();
${jsonData}
    
    String payload;
    serializeJson(doc, payload);
    
    // Send HTTP POST request
    HTTPClient http;
    http.begin(serverURL);
    http.addHeader("Content-Type", "application/json");
    
    int httpResponseCode = http.POST(payload);
    
    if (httpResponseCode > 0) {
      String response = http.getString();
      Serial.println("Data sent successfully");
      Serial.println("Response: " + response);
    } else {
      Serial.println("Error sending data");
      Serial.println("HTTP Response code: " + String(httpResponseCode));
    }
    
    http.end();
  }
  
  delay(30000); // Send data every 30 seconds
}`;
}

// MicroPython Code Generation
function generateMicroPythonCode(deviceType, deviceId, wifiSSID, wifiPassword, serverEndpoint, sensors) {
    let imports = 'import network\nimport urequests\nimport ujson\nimport time\nfrom machine import Pin, ADC\n';
    let sensorImports = '';
    let sensorSetup = '';
    let sensorReadings = '';
    let jsonData = '';
    
    // Add sensor-specific imports and code
    if (sensors.temperature || sensors.humidity) {
        sensorImports += 'import dht\n';
        sensorSetup += '# DHT Sensor setup\ndht_sensor = dht.DHT22(Pin(2))\n';
        if (sensors.temperature && sensors.humidity) {
            sensorReadings += `    try:
        dht_sensor.measure()
        temperature = dht_sensor.temperature()
        humidity = dht_sensor.humidity()
    except:
        temperature = None
        humidity = None\n`;
            jsonData += `    if temperature is not None:
        data['temperature'] = temperature
    if humidity is not None:
        data['humidity'] = humidity\n`;
        } else if (sensors.temperature) {
            sensorReadings += `    try:
        dht_sensor.measure()
        temperature = dht_sensor.temperature()
    except:
        temperature = None\n`;
            jsonData += `    if temperature is not None:
        data['temperature'] = temperature\n`;
        } else if (sensors.humidity) {
            sensorReadings += `    try:
        dht_sensor.measure()
        humidity = dht_sensor.humidity()
    except:
        humidity = None\n`;
            jsonData += `    if humidity is not None:
        data['humidity'] = humidity\n`;
        }
    }
    
    if (sensors.light) {
        sensorSetup += '# Light sensor setup\nldr = ADC(Pin(36))\nldr.atten(ADC.ATTN_11DB)\n';
        sensorReadings += '    light_level = ldr.read()\n';
        jsonData += '    data["light"] = light_level\n';
    }
    
    if (sensors.motion) {
        sensorSetup += '# Motion sensor setup\npir = Pin(3, Pin.IN)\n';
        sensorReadings += '    motion = pir.value()\n';
        jsonData += '    data["motion"] = bool(motion)\n';
    }
    
    if (sensors.gas) {
        sensorSetup += '# Gas sensor setup\ngas_sensor = ADC(Pin(39))\ngas_sensor.atten(ADC.ATTN_11DB)\n';
        sensorReadings += '    gas_level = gas_sensor.read()\n';
        jsonData += '    data["gas"] = gas_level\n';
    }
    
    return `${imports}${sensorImports}
# WiFi Configuration
SSID = "${wifiSSID}"
PASSWORD = "${wifiPassword}"
SERVER_URL = "${serverEndpoint}"
DEVICE_ID = "${deviceId}"

# Connect to WiFi
def connect_wifi():
    wlan = network.WLAN(network.STA_IF)
    wlan.active(True)
    wlan.connect(SSID, PASSWORD)
    
    print("Connecting to WiFi", end="")
    while not wlan.isconnected():
        print(".", end="")
        time.sleep(0.5)
    
    print("\\nWiFi connected!")
    print("IP address:", wlan.ifconfig()[0])
    return wlan

# Sensor setup
${sensorSetup}
# Send sensor data
def send_data():
    try:
        # Read sensor data
${sensorReadings}
        
        # Create data payload
        data = {
            "device_id": DEVICE_ID,
            "timestamp": time.ticks_ms()
        }
        
${jsonData}
        
        # Send HTTP POST request
        response = urequests.post(
            SERVER_URL,
            headers={'Content-Type': 'application/json'},
            data=ujson.dumps(data)
        )
        
        if response.status_code == 200:
            print("Data sent successfully")
            print("Response:", response.text)
        else:
            print("Error sending data. Status code:", response.status_code)
            
        response.close()
        
    except Exception as e:
        print("Error:", str(e))

# Main program
def main():
    wlan = connect_wifi()
    
    while True:
        if wlan.isconnected():
            send_data()
        else:
            print("WiFi disconnected, attempting to reconnect...")
            wlan = connect_wifi()
        
        time.sleep(30)  # Send data every 30 seconds

# Run the program
if __name__ == "__main__":
    main()`;
}

// Switch between code languages
function switchCodeLanguage(language) {
    currentCodeLanguage = language;
    
    // Update button styles
    document.getElementById('arduinoBtn').classList.toggle('active', language === 'arduino');
    document.getElementById('micropythonBtn').classList.toggle('active', language === 'micropython');
    
    // Update code syntax highlighting class
    const codeElement = document.getElementById('generatedCode');
    if (language === 'arduino') {
        codeElement.className = 'language-cpp';
    } else {
        codeElement.className = 'language-python';
    }
    
    generateCode();
}

// Copy code to clipboard
function copyCode() {
    const code = document.getElementById('generatedCode').textContent;
    navigator.clipboard.writeText(code).then(() => {
        showAlert('Code copied to clipboard!', 'success');
    }).catch(err => {
        console.error('Failed to copy: ', err);
        showAlert('Failed to copy code', 'error');
    });
}

// Download code as file
function downloadCode() {
    const code = document.getElementById('generatedCode').textContent;
    const deviceId = document.getElementById('device_id').value || 'device';
    const fileExtension = currentCodeLanguage === 'arduino' ? 'ino' : 'py';
    const fileName = `${deviceId}_${currentCodeLanguage}.${fileExtension}`;
    
    const blob = new Blob([code], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    showAlert(`Code downloaded as ${fileName}`, 'success');
}

// Show alert messages
function showAlert(message, type) {
    const alertToast = document.getElementById('alertToast');
    const alertMessage = document.getElementById('alertMessage');
    
    alertMessage.textContent = message;
    
    // Update toast styling based on type
    alertToast.classList.remove('bg-success', 'bg-danger', 'text-white');
    if (type === 'success') {
        alertToast.classList.add('bg-success', 'text-white');
    } else if (type === 'error') {
        alertToast.classList.add('bg-danger', 'text-white');
    }
    
    const toast = new bootstrap.Toast(alertToast);
    toast.show();
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Set default code language button as active
    document.getElementById('arduinoBtn').classList.add('active');
    
    // Generate initial placeholder code
    generateCode();
});
</script>

<style>
#generatedCode {
    background-color: #f8f9fa;
    border: none;
    font-family: 'Courier New', monospace;
    font-size: 12px;
    line-height: 1.4;
    margin: 0;
    padding: 20px;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.form-check-label {
    font-size: 0.95rem;
}

.btn-group .btn.active {
    background-color: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
}

.card-header h6 {
    color: #495057;
}

.text-yellow {
    color: #ffc107 !important;
}

.toast-container {
    z-index: 1050;
}
</style>
{% endblock %}
