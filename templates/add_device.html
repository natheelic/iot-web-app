{% extends "base.html" %}
{% block title %}Add Device{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card shadow">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-plus me-2"></i>Add New IoT Device
                </h5>
            </div>
            <div class="card-body">
                <form id="deviceForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="device_id" class="form-label">Device ID *</label>
                            <input type="text" class="form-control" id="device_id" name="device_id" required>
                            <div class="form-text">Unique identifier for the device (e.g., ESP32_001)</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="device_name" class="form-label">Device Name *</label>
                            <input type="text" class="form-control" id="device_name" name="device_name" required>
                            <div class="form-text">Human-readable name for the device</div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="device_type" class="form-label">Device Type *</label>
                            <select class="form-select" id="device_type" name="device_type" required>
                                <option value="">Select device type...</option>
                                <option value="ESP32">ESP32</option>
                                <option value="PICO WH">Raspberry Pi Pico WH</option>
                                <option value="Arduino">Arduino</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="location" class="form-label">Location</label>
                            <input type="text" class="form-control" id="location" name="location" placeholder="e.g., Living Room, Office">
                            <div class="form-text">Physical location of the device (optional)</div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <h6>Expected Sensors</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="has_temperature">
                                    <label class="form-check-label" for="has_temperature">
                                        <i class="fas fa-thermometer-half me-1"></i>Temperature
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="has_humidity">
                                    <label class="form-check-label" for="has_humidity">
                                        <i class="fas fa-tint me-1"></i>Humidity
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="has_pressure">
                                    <label class="form-check-label" for="has_pressure">
                                        <i class="fas fa-gauge-high me-1"></i>Pressure
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="has_light">
                                    <label class="form-check-label" for="has_light">
                                        <i class="fas fa-lightbulb me-1"></i>Light Sensor
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="has_motion">
                                    <label class="form-check-label" for="has_motion">
                                        <i class="fas fa-running me-1"></i>Motion Detector
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>Add Device
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Device Code Generation -->
        <div class="card shadow mt-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-code me-2"></i>Generated Device Code
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted">After adding your device, copy the code below to your IoT device:</p>
                <div id="device-code" class="d-none">
                    <ul class="nav nav-tabs" id="codeTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="arduino-tab" data-bs-toggle="tab" data-bs-target="#arduino" type="button" role="tab">Arduino/ESP32</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="python-tab" data-bs-toggle="tab" data-bs-target="#python" type="button" role="tab">Python (Pico)</button>
                        </li>
                    </ul>
                    <div class="tab-content" id="codeTabContent">
                        <div class="tab-pane fade show active" id="arduino" role="tabpanel">
                            <pre><code id="arduino-code" class="language-cpp"></code></pre>
                            <button class="btn btn-sm btn-outline-primary mt-2" onclick="copyCode('arduino-code')">
                                <i class="fas fa-copy me-1"></i>Copy Arduino Code
                            </button>
                        </div>
                        <div class="tab-pane fade" id="python" role="tabpanel">
                            <pre><code id="python-code" class="language-python"></code></pre>
                            <button class="btn btn-sm btn-outline-primary mt-2" onclick="copyCode('python-code')">
                                <i class="fas fa-copy me-1"></i>Copy Python Code
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('deviceForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const deviceData = {
        device_id: formData.get('device_id'),
        device_name: formData.get('device_name'),
        device_type: formData.get('device_type'),
        location: formData.get('location')
    };

    fetch('/devices', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(deviceData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Show success message
            const alert = document.createElement('div');
            alert.className = 'alert alert-success alert-dismissible fade show';
            alert.innerHTML = `
                <strong>Success!</strong> Device added successfully.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.card-body').insertBefore(alert, document.getElementById('deviceForm'));
            
            // Generate code
            generateDeviceCode(deviceData);
            
            // Reset form
            this.reset();
        } else {
            // Show error message
            const alert = document.createElement('div');
            alert.className = 'alert alert-danger alert-dismissible fade show';
            alert.innerHTML = `
                <strong>Error!</strong> ${data.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.card-body').insertBefore(alert, document.getElementById('deviceForm'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        const alert = document.createElement('div');
        alert.className = 'alert alert-danger alert-dismissible fade show';
        alert.innerHTML = `
            <strong>Error!</strong> Failed to add device.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.card-body').insertBefore(alert, document.getElementById('deviceForm'));
    });
});

function generateDeviceCode(deviceData) {
    const serverUrl = window.location.origin;
    
    // Arduino/ESP32 Code
    const arduinoCode = `#include <WiFi.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>

const char* ssid = "YOUR_WIFI_SSID";
const char* password = "YOUR_WIFI_PASSWORD";
const char* serverURL = "${serverUrl}/api/sensor-data";
const char* deviceID = "${deviceData.device_id}";

void setup() {
  Serial.begin(115200);
  WiFi.begin(ssid, password);
  
  while (WiFi.status() != WL_CONNECTED) {
    delay(1000);
    Serial.println("Connecting to WiFi...");
  }
  Serial.println("Connected to WiFi");
}

void loop() {
  if (WiFi.status() == WL_CONNECTED) {
    HTTPClient http;
    http.begin(serverURL);
    http.addHeader("Content-Type", "application/json");
    
    // Create JSON payload
    StaticJsonDocument<200> doc;
    doc["device_id"] = deviceID;
    ${document.getElementById('has_temperature').checked ? 'doc["temperature"] = 25.5; // Replace with actual sensor reading' : ''}
    ${document.getElementById('has_humidity').checked ? 'doc["humidity"] = 60.0; // Replace with actual sensor reading' : ''}
    ${document.getElementById('has_pressure').checked ? 'doc["pressure"] = 1013.25; // Replace with actual sensor reading' : ''}
    ${document.getElementById('has_light').checked ? 'doc["light"] = 500.0; // Replace with actual sensor reading' : ''}
    ${document.getElementById('has_motion').checked ? 'doc["motion"] = false; // Replace with actual sensor reading' : ''}
    
    String jsonString;
    serializeJson(doc, jsonString);
    
    int httpResponseCode = http.POST(jsonString);
    
    if (httpResponseCode > 0) {
      String response = http.getString();
      Serial.println("Data sent successfully");
    } else {
      Serial.println("Error sending data");
    }
    
    http.end();
  }
  
  delay(10000); // Send data every 10 seconds
}`;

    // Python Code for Pico
    const pythonCode = `import network
import urequests
import json
import time

# WiFi Configuration
SSID = "YOUR_WIFI_SSID"
PASSWORD = "YOUR_WIFI_PASSWORD"
SERVER_URL = "${serverUrl}/api/sensor-data"
DEVICE_ID = "${deviceData.device_id}"

def connect_wifi():
    wlan = network.WLAN(network.STA_IF)
    wlan.active(True)
    wlan.connect(SSID, PASSWORD)
    
    while not wlan.isconnected():
        print("Connecting to WiFi...")
        time.sleep(1)
    
    print("Connected to WiFi")
    print("IP:", wlan.ifconfig()[0])

def send_sensor_data():
    data = {
        "device_id": DEVICE_ID,
        ${document.getElementById('has_temperature').checked ? '"temperature": 25.5,  # Replace with actual sensor reading' : ''}
        ${document.getElementById('has_humidity').checked ? '"humidity": 60.0,  # Replace with actual sensor reading' : ''}
        ${document.getElementById('has_pressure').checked ? '"pressure": 1013.25,  # Replace with actual sensor reading' : ''}
        ${document.getElementById('has_light').checked ? '"light": 500.0,  # Replace with actual sensor reading' : ''}
        ${document.getElementById('has_motion').checked ? '"motion": False  # Replace with actual sensor reading' : ''}
    }
    
    try:
        response = urequests.post(SERVER_URL, 
                                json=data, 
                                headers={'Content-Type': 'application/json'})
        if response.status_code == 200:
            print("Data sent successfully")
        else:
            print("Error sending data:", response.status_code)
        response.close()
    except Exception as e:
        print("Error:", str(e))

# Main program
connect_wifi()

while True:
    send_sensor_data()
    time.sleep(10)  # Send data every 10 seconds`;

    document.getElementById('arduino-code').textContent = arduinoCode;
    document.getElementById('python-code').textContent = pythonCode;
    document.getElementById('device-code').classList.remove('d-none');
}

function copyCode(elementId) {
    const code = document.getElementById(elementId).textContent;
    navigator.clipboard.writeText(code).then(function() {
        // Show success feedback
        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check me-1"></i>Copied!';
        btn.classList.remove('btn-outline-primary');
        btn.classList.add('btn-success');
        
        setTimeout(function() {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-primary');
        }, 2000);
    });
}
</script>
{% endblock %}
